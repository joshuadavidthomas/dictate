name: build

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/build.yml
      - src/**
      - src-tauri/**
      - dist/aur/**
      - package.json
      - bun.lock
  pull_request:
  workflow_call:
    inputs:
      version:
        description: Version tag for release packaging
        required: false
        type: string
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  linux:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libvulkan-dev \
            glslc

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Import GPG key
        if: ${{ inputs.version != '' }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Build Tauri app
        env:
          APPIMAGETOOL_FORCE_SIGN: ${{ inputs.version != '' && '1' || '' }}
          APPIMAGETOOL_SIGN_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          SIGN: ${{ inputs.version != '' && '1' || '' }}
          SIGN_KEY: C08D335E8E763F5DE980FA12E796EC7D2E9F27A3
          TAURI_SIGNING_RPM_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          TAURI_SIGNING_RPM_KEY_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: bun run tauri build

      - name: Generate checksums
        working-directory: src-tauri/target/release/bundle
        run: |
          sha256sum deb/*.deb > deb/SHA256SUMS
          sha256sum appimage/*.AppImage > appimage/SHA256SUMS
          sha256sum rpm/*.rpm > rpm/SHA256SUMS
          sha256sum *.tar.gz > SHA256SUMS.tar.gz

      - name: Upload deb
        uses: actions/upload-artifact@v5
        with:
          name: bundle-deb
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/SHA256SUMS

      - name: Upload AppImage
        uses: actions/upload-artifact@v5
        with:
          name: bundle-appimage
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/SHA256SUMS

      - name: Upload rpm
        uses: actions/upload-artifact@v5
        with:
          name: bundle-rpm
          path: |
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/rpm/SHA256SUMS

      - name: Upload tar.gz
        uses: actions/upload-artifact@v5
        with:
          name: bundle-tar
          path: |
            src-tauri/target/release/bundle/*.tar.gz
            src-tauri/target/release/bundle/SHA256SUMS.tar.gz

  test-aur:
    runs-on: ubuntu-24.04
    container:
      image: archlinux:latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel namcap git

      - name: Create build user
        run: |
          useradd -m builder
          chown -R builder:builder .

      - name: Test dictate-bin PKGBUILD
        working-directory: dist/aur/dictate-bin
        run: |
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          su builder -c 'namcap PKGBUILD' || true

      - name: Test dictate-git PKGBUILD
        working-directory: dist/aur/dictate-git
        run: |
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          su builder -c 'namcap PKGBUILD' || true

      - name: Build test dictate-git
        if: ${{ inputs.version != '' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
        run: |
          pacman -S --noconfirm --needed git rust bun libappindicator-gtk3 librsvg patchelf vulkan-headers shaderc
          chown -R builder:builder .
          cd dist/aur/dictate-git
          su builder -c 'makepkg --noconfirm --clean --cleanbuild --skippgpcheck'

  attest:
    runs-on: ubuntu-24.04
    if: ${{ inputs.version != '' }}
    needs: [linux]
    permissions:
      id-token: write
      attestations: write
    steps:
      - uses: actions/download-artifact@v6

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            bundle-deb/*
            bundle-appimage/*
            bundle-rpm/*
            bundle-tar/*
