name: build

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/build.yml
      - src/**
      - src-tauri/**
      - package.json
      - bun.lock
  pull_request:
  workflow_call:
    inputs:
      version:
        description: Version tag for release packaging
        required: false
        type: string
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  linux:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libvulkan-dev \
            glslc

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        run: bun run tauri build

      - name: Generate checksums
        working-directory: src-tauri/target/release/bundle
        run: |
          sha256sum deb/*.deb > deb/SHA256SUMS
          sha256sum appimage/*.AppImage > appimage/SHA256SUMS
          sha256sum rpm/*.rpm > rpm/SHA256SUMS

      - name: Upload deb
        uses: actions/upload-artifact@v5
        with:
          name: bundle-deb
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/SHA256SUMS

      - name: Upload AppImage
        uses: actions/upload-artifact@v5
        with:
          name: bundle-appimage
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/SHA256SUMS

      - name: Upload rpm
        uses: actions/upload-artifact@v5
        with:
          name: bundle-rpm
          path: |
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/rpm/SHA256SUMS

  attest:
    runs-on: ubuntu-latest
    if: ${{ inputs.version != '' }}
    needs: [build-linux]
    permissions:
      id-token: write
      attestations: write
    steps:
      - uses: actions/download-artifact@v6

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            bundle-deb/*
            bundle-appimage/*
            bundle-rpm/*
